<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout}">

<th:block layout:fragment="head">
  <style>
    body {
      font-family: var(--font-family-base);
      text-align: center;
      padding: var(--spacing-lg);
      font-size: var(--font-size-base);
    }
    .question-card {
      max-width: 600px;
      margin: 0 auto;
      background: var(--white);
      border-radius: var(--border-radius-lg);
      padding: var(--spacing-xl);
      box-shadow: var(--shadow-md);
      border: 1px solid var(--border-color);
    }
    .question-card h2 {
      font-size: var(--font-size-xl);
      font-weight: var(--font-weight-bold);
      color: var(--primary-color);
      margin-bottom: var(--spacing-lg);
    }
    .question-card p {
      font-size: var(--font-size-lg);
      color: var(--gray-700);
      margin-bottom: var(--spacing-xl);
      line-height: 1.5;
    }
    .answer {
      margin: var(--spacing-md) 0;
      padding: var(--spacing-lg);
      background: var(--light-gray);
      border-radius: var(--border-radius-md);
      cursor: pointer;
      transition: all var(--transition-normal);
      border: 2px solid transparent;
      font-size: var(--font-size-base);
      color: var(--gray-700);
    }
    .answer:hover {
      background: var(--primary-lighter);
      border-color: var(--primary-color);
      transform: translateY(-2px);
      box-shadow: var(--shadow-sm);
    }
    .answer.selected {
      background: var(--primary-color);
      color: var(--white);
      border-color: var(--primary-dark);
    }

    /* === 진행도 바 추가 === */
    .progress-wrap{
      max-width: 640px;
      margin: 0 auto var(--spacing-lg,24px);
      text-align:left;
    }
    .progress-head{
      display:flex; justify-content:space-between; align-items:center;
      font-size: var(--font-size-sm, 14px);
      color: var(--gray-600, #6b7280);
      margin-bottom: 8px;
    }
    .progress{
      position: relative; height: 10px; background:#eef2f7; border-radius: 999px;
      overflow: hidden; box-shadow: inset 0 1px 2px rgba(0,0,0,.04);
    }
    .progress > i{
      display:block; height:100%; width:0%;
      background: linear-gradient(90deg, #2f6bff, #7aa1ff);
      border-radius: 999px;
      transition: width .35s ease;
    }
    .progress-label{ font-weight:700; color:#0f172a; }
  </style>
</th:block>

<div layout:fragment="content">
  <!-- 진행도 바 -->
  <div class="progress-wrap" aria-label="질문 진행도">
    <div class="progress-head">
      <span>진행도</span>
      <span class="progress-label" id="progressText">0 / 6</span>
    </div>
    <div class="progress" role="progressbar"
         aria-valuemin="0" aria-valuemax="6" aria-valuenow="0" aria-live="polite">
      <i id="progressBar"></i>
    </div>
  </div>

  <!-- 질문 영역 -->
  <div id="quiz"></div>

  <form id="resultForm" action="/test/result" method="post" style="display:none">
    <input type="hidden" name="q1">
    <input type="hidden" name="q2">
    <input type="hidden" name="q3">
    <input type="hidden" name="q4">
    <input type="hidden" name="q5">
    <input type="hidden" name="q6">
  </form>
</div>

<th:block layout:fragment="scripts">
  <script>
    const questions = [
      {
        text: "어떤 숙소 타입이 가장 끌려?",
        answers: [
          { text: "자연 속 조용한 펜션", value: "healing" },
          { text: "도심 속 감성 부티크 호텔", value: "emotion" },
          { text: "친구들과 함께 가는 대형 풀빌라", value: "activity" },
          { text: "가성비 좋은 비즈니스 호텔", value: "challenge" }
        ],
        key: "q1"
      },
      {
        text: "숙소에서 보내는 이상적인 하루는?",
        answers: [
          { text: "숙소 안에서 책 읽고 쉬기", value: "healing" },
          { text: "포토존 돌며 사진 남기기", value: "emotion" },
          { text: "수영장, 바베큐, 보드게임 등 풀활용", value: "activity" },
          { text: "숙소는 그냥 잠만 자면 돼", value: "challenge" }
        ],
        key: "q2"
      },
      {
        text: "숙소 고를 때 가장 중요하게 보는 건?",
        answers: [
          { text: "조용하고 프라이빗한 분위기", value: "healing" },
          { text: "인테리어와 감성 분위기", value: "emotion" },
          { text: "친구들과 놀 거리", value: "activity" },
          { text: "가격 대비 실용성", value: "challenge" }
        ],
        key: "q3"
      },
      {
        text: "여행 가서 숙소 체크인은 몇 시쯤 하고 싶어?",
        answers: [
          { text: "여유 있게 낮에 체크인", value: "healing" },
          { text: "일몰 직전 도착해서 뷰 감상", value: "emotion" },
          { text: "도착하자마자 활동 후 늦게 체크인", value: "activity" },
          { text: "그날 사정 봐서 즉흥적으로", value: "challenge" }
        ],
        key: "q4"
      },
      {
        text: "아침 식사는 어떻게 하고 싶어?",
        answers: [
          { text: "숙소 안에서 조용히 먹기", value: "healing" },
          { text: "브런치 감성 카페 탐방", value: "emotion" },
          { text: "근처 시장에서 사먹기", value: "activity" },
          { text: "안 먹고 바로 일정 ㄱ", value: "challenge" }
        ],
        key: "q5"
      },
      {
        text: "가장 선호하는 숙소 옵션은?",
        answers: [
          { text: "전망 좋은 창문", value: "emotion" },
          { text: "조용한 단독 공간", value: "healing" },
          { text: "바베큐, 노래방, 보드게임 등 부대시설", value: "activity" },
          { text: "편의점 근처, 역세권, 저렴한 가격", value: "challenge" }
        ],
        key: "q6"
      }
    ];

    let current = 0;
    const answers = {};
    const total = questions.length;

    // 진행도 DOM
    const progressText = document.getElementById('progressText');
    const progressBar  = document.getElementById('progressBar');
    const progressEl   = document.querySelector('.progress');

    function updateProgress() {
      const shown = Math.min(current + 1, total);
      const pct = Math.round((shown / total) * 100);

      progressText.textContent = `${shown} / ${total}`;
      progressBar.style.width = `${pct}%`;

      progressEl.setAttribute('aria-valuenow', String(shown));
    }

    function showQuestion() {
      const q = questions[current];
      const container = document.getElementById("quiz");
      container.innerHTML = `
        <div class="question-card">
          <h2>Q${current + 1}</h2>
          <p>${q.text}</p>
          ${q.answers.map(a => `
            <div class="answer" onclick="chooseAnswer(event, '${q.key}', '${a.value}')">
              ${a.text}
            </div>`).join('')}
        </div>
      `;
      updateProgress();
    }

    // event를 명시적으로 받아서 사용 (일부 브라우저의 전역 event 의존 제거)
    function chooseAnswer(ev, key, value) {
      answers[key] = value;

      // 선택 하이라이트
      const answerElements = document.querySelectorAll('.answer');
      answerElements.forEach(el => el.classList.remove('selected'));
      if (ev && ev.currentTarget) {
        ev.currentTarget.classList.add('selected');
      } else if (ev && ev.target) {
        ev.target.classList.add('selected');
      }

      setTimeout(() => {
        current++;
        if (current < total) {
          showQuestion();
        } else {
          // 마지막 문항 처리: 100% 반영 후 제출
          updateProgress();
          submitAnswers();
        }
      }, 500);
    }

    function submitAnswers() {
      Object.keys(answers).forEach(key => {
        const input = document.querySelector(`input[name="${key}"]`);
        if (input) input.value = answers[key];
      });
      document.getElementById('resultForm').submit();
    }

    document.addEventListener('DOMContentLoaded', function() {
      showQuestion();
    });
  </script>
</th:block>
