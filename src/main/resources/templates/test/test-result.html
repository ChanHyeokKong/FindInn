<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>ì—¬í–‰ ì„±í–¥ ê²°ê³¼</title>

  <!-- âœ… CSRF (ìˆì„ ë•Œë§Œ) -->
  <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}">

  <style>
    :root{
      --bg:#fbfcfe; --card:#fff; --ink:#0f172a; --muted:#64748b;
      --shadow:0 16px 40px rgba(15,23,42,.08); --r:18px;
      --bar-bg:#e9eef5;
      --act:#f59e0b;      /* Activity: orange */
      --heal:#10b981;     /* Healing: green  */
      --chal:#db2777;     /* Challenge: pink */
      --emo:#3b82f6;      /* Emotion: blue   */
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;color:var(--ink);background:var(--bg);padding:30px;text-align:center}
    .card{max-width:820px;margin:0 auto;background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);padding:32px}
    h1{margin:0 0 6px;font-size:28px}
    .subtitle{margin:0 0 18px;color:var(--muted)}
    .hero{margin:10px 0 14px}
    .hero img{max-width:260px;border-radius:12px}
    .desc{margin:8px 0 16px;color:#334155}
    .section-title{margin:18px 0 10px;font-weight:700}
    .row{margin:14px 0}
    .label{display:flex;justify-content:space-between;align-items:center;margin:0 auto 6px;width:82%}
    .label span:first-child{font-weight:600}
    .pill{font-size:12px;background:#eef2ff;color:#3730a3;border-radius:999px;padding:4px 8px}
    .bar-wrap{width:82%;height:14px;background:var(--bar-bg);border-radius:999px;margin:0 auto;overflow:hidden}
    .bar{height:100%}
    .bar.activity{background:var(--act)}
    .bar.healing{background:var(--heal)}
    .bar.challenge{background:var(--chal)}
    .bar.emotion{background:var(--emo)}
    .recos{margin-top:18px}
    .recos ul{list-style:none;padding:0;margin:6px 0 0}
    .recos li{margin:6px 0;color:#475569}
    .ctl{margin-top:16px}
    .btn{display:inline-block;border:0;background:#2f6bff;color:#fff;padding:10px 14px;border-radius:10px;text-decoration:none;cursor:pointer}
    .btn[disabled]{background:#93b0ff;cursor:not-allowed}

    /* --- Modal --- */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center;
           background:rgba(15,23,42,.45); z-index:1000;}
    .modal.open{display:flex;}
    .modal-dialog{background:#fff; border-radius:16px; padding:22px 20px; width:min(92vw,420px);
                  box-shadow:var(--shadow); text-align:center}
    .modal-title{margin:0 0 6px; font-size:18px; font-weight:700}
    .modal-msg{margin:8px 0 14px; color:#334155}
    .modal-actions{display:flex; justify-content:center; gap:10px}
    .btn-outline{background:#fff; color:#1f2937; border:1px solid #e5e7eb; border-radius:10px; padding:8px 12px; cursor:pointer}
  </style>
</head>
<body>
<div class="card"
     th:with="levels=${levels != null ? levels : {'activity':0,'healing':0,'emotion':0,'challenge':0}}">
  <h1>ğŸ‰ ë‹¹ì‹ ì˜ ì—¬í–‰ ë¶€ìºëŠ”?</h1>
  <p class="subtitle"
     th:text="${character != null
               ? (character.name + (character.code != null ? ' (' + character.code + ')' : ''))
               : (#strings.capitalize(topTrait))}">
    ê²°ê³¼ëª… (ì½”ë“œ)
  </p>

  <div class="hero" th:if="${character != null && character.imageUrl != null}">
    <img th:src="${character.imageUrl}" alt="ìºë¦­í„° ì´ë¯¸ì§€">
  </div>

  <p class="desc"
     th:text="${character != null && character.description != null ? character.description : 'ì„¤ëª…ì´ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.'}">
    ì„¤ëª…ë¬¸êµ¬
  </p>

  <h3 class="section-title">ğŸ“Š ëŠ¥ë ¥ì¹˜</h3>

  <!-- Activity -->
  <div class="row">
    <div class="label">
      <span>Activity</span>
      <span class="pill" th:text="${levels['activity']} + '%'">0%</span>
    </div>
    <div class="bar-wrap">
      <div class="bar activity" th:style="|width:${levels['activity']?:0}%|"></div>
    </div>
  </div>

  <!-- Healing -->
  <div class="row">
    <div class="label">
      <span>Healing</span>
      <span class="pill" th:text="${levels['healing']} + '%'">0%</span>
    </div>
    <div class="bar-wrap">
      <div class="bar healing" th:style="|width:${levels['healing']?:0}%|"></div>
    </div>
  </div>

  <!-- Challenge -->
  <div class="row">
    <div class="label">
      <span>Challenge</span>
      <span class="pill" th:text="${levels['challenge']} + '%'">0%</span>
    </div>
    <div class="bar-wrap">
      <div class="bar challenge" th:style="|width:${levels['challenge']?:0}%|"></div>
    </div>
  </div>

  <!-- Emotion -->
  <div class="row">
    <div class="label">
      <span>Emotion</span>
      <span class="pill" th:text="${levels['emotion']} + '%'">0%</span>
    </div>
    <div class="bar-wrap">
      <div class="bar emotion" th:style="|width:${levels['emotion']?:0}%|"></div>
    </div>
  </div>

  <!-- ì¶”ì²œ ìˆ™ì†Œ -->
  <div class="recos"
       th:if="${character != null && character.recommendedAccommodations != null && !#lists.isEmpty(character.recommendedAccommodations)}">
    <h3 class="section-title">ğŸ¨ ì¶”ì²œ ìˆ™ì†Œ</h3>
    <ul>
      <li th:each="acc : ${character.recommendedAccommodations}" th:text="${acc}">ìˆ™ì†Œ</li>
    </ul>
  </div>

  <!-- ì¿ í° ë²„íŠ¼ (AJAX + ëª¨ë‹¬) -->
  <div class="ctl" th:if="${topTrait != null}">
    <input type="hidden" id="traitVal" th:value="${topTrait}">
    <!-- âœ… ì´ë²¤íŠ¸ ì½”ë“œ ë°ì´í„° ì†ì„± ì¶”ê°€ -->
    <button type="button" id="btn-coupon" class="btn" data-event="event-test">ğŸ ì¿ í° ë°›ê¸°</button>
  </div>
</div>

<!-- Modal -->
<div id="couponModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="couponTitle">
  <div class="modal-dialog">
    <h4 id="couponTitle" class="modal-title">ì¿ í° ë°œê¸‰</h4>
    <p id="couponMsg" class="modal-msg">ì²˜ë¦¬ ì¤‘â€¦</p>
    <div class="modal-actions">
      <button type="button" id="modalClose" class="btn-outline">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<script>
  // ===== CSRF =====
  const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content || null;
  const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';

  // ===== Elements =====
  const $btn   = document.getElementById('btn-coupon');
  const $modal = document.getElementById('couponModal');
  const $msg   = document.getElementById('couponMsg');
  const $close = document.getElementById('modalClose');

  function openModal(text){ $msg.textContent = text; $modal.classList.add('open'); $modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ $modal.classList.remove('open'); $modal.setAttribute('aria-hidden','true'); }
  $close?.addEventListener('click', closeModal);
  $modal?.addEventListener('click', (e)=>{ if(e.target === $modal) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });

  // ===== Helpers =====
  const EVENT_CODE = $btn?.dataset.event || 'event-test';
  const LS_KEY = `coupon_issued:${EVENT_CODE}`;

  function lockButton(){
    if (!$btn) return;
    $btn.disabled = true;
    $btn.textContent = 'ë°œê¸‰ ì™„ë£Œ âœ…';
  }

  function unlockButton(){
    if (!$btn) return;
    $btn.disabled = false;
    $btn.textContent = 'ğŸ ì¿ í° ë°›ê¸°';
  }

  // ===== ì´ˆê¸° ë™ê¸°í™” (ì„œë²„ ìƒíƒœ í™•ì¸) =====
  (async function syncIssued(){
    try {
      // ë¡œì»¬ì— ì´ë¯¸ ì°í˜€ ìˆìœ¼ë©´ ë°”ë¡œ ì ê¸ˆ
      if (localStorage.getItem(LS_KEY) === '1') { lockButton(); return; }

      // ì„œë²„ì—ë„ ë¬¼ì–´ë³´ê¸° (ë‹¤ë¥¸ ê¸°ê¸°/ë¸Œë¼ìš°ì €ì—ì„œ ì´ë¯¸ ë°›ì•˜ì„ ìˆ˜ ìˆìŒ)
      const r = await fetch(`/event/coupon/issued?eventCode=${encodeURIComponent(EVENT_CODE)}`, {
        headers: csrfToken ? { [csrfHeader]: csrfToken } : {}
      });
      if (r.ok) {
        const { issued } = await r.json();
        if (issued) {
          localStorage.setItem(LS_KEY, '1');
          lockButton();
        } else {
          unlockButton();
        }
      }
    } catch (e) {
      // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ ì‹œì—” ì¡°ìš©íˆ ë„˜ì–´ê° (ë²„íŠ¼ì€ ê¸°ë³¸ ìƒíƒœ ìœ ì§€)
    }
  })();

  // ===== í´ë¦­ ì²˜ë¦¬ (AJAX) =====
  $btn?.addEventListener('click', async () => {
    // í”„ë¡ íŠ¸ ê°€ë“œ: ì´ë¯¸ ë°œê¸‰ ìƒíƒœë©´ ì„œë²„ ì•ˆ ê°€ê³  ë°”ë¡œ ì•ˆë‚´
    if (localStorage.getItem(LS_KEY) === '1' || $btn.disabled) {
      openModal('ì´ë¯¸ ì¿ í°ì„ ë°œê¸‰ë°›ì•˜ìŠµë‹ˆë‹¤ ğŸ');
      return;
    }

    const trait = document.getElementById('traitVal')?.value || '';
    $btn.disabled = true;

    try {
      const headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
      if (csrfToken) headers[csrfHeader] = csrfToken;

      const res = await fetch('/event/test/issue-coupon', {
        method: 'POST',
        headers,
        body: new URLSearchParams({ trait })
      });

      if (res.status === 401) { location.href = '/login'; return; }

      let data = null;
      try { data = await res.json(); } catch(_) {}

      if (res.ok && data?.ok) {
        localStorage.setItem(LS_KEY, '1');
        lockButton();
        openModal(data.message || 'ì¿ í° ë°œê¸‰ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ');
      } else {
        // ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ì¤‘ë³µ ì‹œ code=ALREADY_ISSUED ë‚´ë ¤ì£¼ë„ë¡ ìˆ˜ì •í•´ë‘” ìƒíƒœ
        const code = data?.code || '';
        const msg  = data?.message || '';
        if (code === 'ALREADY_ISSUED' || /ì´ë¯¸.*ë°œê¸‰/.test(msg)) {
          localStorage.setItem(LS_KEY, '1');
          lockButton();
          openModal('ì´ë¯¸ ì¿ í°ì„ ë°œê¸‰ë°›ì•˜ìŠµë‹ˆë‹¤ ğŸ');
        } else {
          openModal(msg || 'ì¿ í° ë°œê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          $btn.disabled = false; // ì‹¤íŒ¨ ì‹œ ì¬ì‹œë„ ê°€ëŠ¥
        }
      }
    } catch (err) {
      openModal('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      $btn.disabled = false;
    }
  });
</script>
</body>
</html>