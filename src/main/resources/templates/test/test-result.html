<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8" />
  <title>여행 성향 결과</title>

  <!-- ✅ CSRF (있을 때만) -->
  <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}">

  <style>
    :root{
      --bg:#fbfcfe; --card:#fff; --ink:#0f172a; --muted:#64748b;
      --shadow:0 16px 40px rgba(15,23,42,.08); --r:18px;
      --bar-bg:#e9eef5;
      --act:#f59e0b;      /* Activity: orange */
      --heal:#10b981;     /* Healing: green  */
      --chal:#db2777;     /* Challenge: pink */
      --emo:#3b82f6;      /* Emotion: blue   */
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;color:var(--ink);background:var(--bg);padding:30px;text-align:center}
    .card{max-width:820px;margin:0 auto;background:var(--card);border-radius:var(--r);box-shadow:var(--shadow);padding:32px}
    h1{margin:0 0 6px;font-size:28px}
    .subtitle{margin:0 0 18px;color:var(--muted)}
    .hero{margin:10px 0 14px}
    .hero img{max-width:260px;border-radius:12px}
    .desc{margin:8px 0 16px;color:#334155}
    .section-title{margin:18px 0 10px;font-weight:700}
    .row{margin:14px 0}
    .label{display:flex;justify-content:space-between;align-items:center;margin:0 auto 6px;width:82%}
    .label span:first-child{font-weight:600}
    .pill{font-size:12px;background:#eef2ff;color:#3730a3;border-radius:999px;padding:4px 8px}
    .bar-wrap{width:82%;height:14px;background:var(--bar-bg);border-radius:999px;margin:0 auto;overflow:hidden}
    .bar{height:100%}
    .bar.activity{background:var(--act)}
    .bar.healing{background:var(--heal)}
    .bar.challenge{background:var(--chal)}
    .bar.emotion{background:var(--emo)}
    .recos{margin-top:18px}
    .recos ul{list-style:none;padding:0;margin:6px 0 0}
    .recos li{margin:6px 0;color:#475569}
    .ctl{margin-top:16px}
    .btn{display:inline-block;border:0;background:#2f6bff;color:#fff;padding:10px 14px;border-radius:10px;text-decoration:none;cursor:pointer}
    .btn[disabled]{background:#93b0ff;cursor:not-allowed}

    /* --- Modal --- */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center;
           background:rgba(15,23,42,.45); z-index:1000;}
    .modal.open{display:flex;}
    .modal-dialog{background:#fff; border-radius:16px; padding:22px 20px; width:min(92vw,420px);
                  box-shadow:var(--shadow); text-align:center}
    .modal-title{margin:0 0 6px; font-size:18px; font-weight:700}
    .modal-msg{margin:8px 0 14px; color:#334155}
    .modal-actions{display:flex; justify-content:center; gap:10px}
    .btn-outline{background:#fff; color:#1f2937; border:1px solid #e5e7eb; border-radius:10px; padding:8px 12px; cursor:pointer}
  </style>
</head>
<body>
<div class="card"
     th:with="levels=${levels != null ? levels : {'activity':0,'healing':0,'emotion':0,'challenge':0}}">
  <h1>🎉 당신의 여행 부캐는?</h1>
  <p class="subtitle"
     th:text="${character != null
               ? (character.name + (character.code != null ? ' (' + character.code + ')' : ''))
               : (#strings.capitalize(topTrait))}">
    결과명 (코드)
  </p>

  <div class="hero" th:if="${character != null && character.imageUrl != null}">
    <img th:src="${character.imageUrl}" alt="캐릭터 이미지">
  </div>

  <p class="desc"
     th:text="${character != null && character.description != null ? character.description : '설명이 준비중입니다.'}">
    설명문구
  </p>

  <h3 class="section-title">📊 능력치</h3>

  <!-- Activity -->
  <div class="row">
    <div class="label">
      <span>Activity</span>
      <span class="pill" th:text="${levels['activity']} + '%'">0%</span>
    </div>
    <div class="bar-wrap">
      <div class="bar activity" th:style="|width:${levels['activity']?:0}%|"></div>
    </div>
  </div>

  <!-- Healing -->
  <div class="row">
    <div class="label">
      <span>Healing</span>
      <span class="pill" th:text="${levels['healing']} + '%'">0%</span>
    </div>
    <div class="bar-wrap">
      <div class="bar healing" th:style="|width:${levels['healing']?:0}%|"></div>
    </div>
  </div>

  <!-- Challenge -->
  <div class="row">
    <div class="label">
      <span>Challenge</span>
      <span class="pill" th:text="${levels['challenge']} + '%'">0%</span>
    </div>
    <div class="bar-wrap">
      <div class="bar challenge" th:style="|width:${levels['challenge']?:0}%|"></div>
    </div>
  </div>

  <!-- Emotion -->
  <div class="row">
    <div class="label">
      <span>Emotion</span>
      <span class="pill" th:text="${levels['emotion']} + '%'">0%</span>
    </div>
    <div class="bar-wrap">
      <div class="bar emotion" th:style="|width:${levels['emotion']?:0}%|"></div>
    </div>
  </div>

  <!-- 추천 숙소 -->
  <div class="recos"
       th:if="${character != null && character.recommendedAccommodations != null && !#lists.isEmpty(character.recommendedAccommodations)}">
    <h3 class="section-title">🏨 추천 숙소</h3>
    <ul>
      <li th:each="acc : ${character.recommendedAccommodations}" th:text="${acc}">숙소</li>
    </ul>
  </div>

  <!-- 쿠폰 버튼 (AJAX + 모달) -->
  <div class="ctl" th:if="${topTrait != null}">
    <input type="hidden" id="traitVal" th:value="${topTrait}">
    <!-- ✅ 이벤트 코드 데이터 속성 추가 -->
    <button type="button" id="btn-coupon" class="btn" data-event="event-test">🎁 쿠폰 받기</button>
  </div>
</div>

<!-- Modal -->
<div id="couponModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="couponTitle">
  <div class="modal-dialog">
    <h4 id="couponTitle" class="modal-title">쿠폰 발급</h4>
    <p id="couponMsg" class="modal-msg">처리 중…</p>
    <div class="modal-actions">
      <button type="button" id="modalClose" class="btn-outline">닫기</button>
    </div>
  </div>
</div>

<script>
  // ===== CSRF =====
  const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content || null;
  const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';

  // ===== Elements =====
  const $btn   = document.getElementById('btn-coupon');
  const $modal = document.getElementById('couponModal');
  const $msg   = document.getElementById('couponMsg');
  const $close = document.getElementById('modalClose');

  function openModal(text){ $msg.textContent = text; $modal.classList.add('open'); $modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ $modal.classList.remove('open'); $modal.setAttribute('aria-hidden','true'); }
  $close?.addEventListener('click', closeModal);
  $modal?.addEventListener('click', (e)=>{ if(e.target === $modal) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });

  // ===== Helpers =====
  const EVENT_CODE = $btn?.dataset.event || 'event-test';
  const LS_KEY = `coupon_issued:${EVENT_CODE}`;

  function lockButton(){
    if (!$btn) return;
    $btn.disabled = true;
    $btn.textContent = '발급 완료 ✅';
  }

  function unlockButton(){
    if (!$btn) return;
    $btn.disabled = false;
    $btn.textContent = '🎁 쿠폰 받기';
  }

  // ===== 초기 동기화 (서버 상태 확인) =====
  (async function syncIssued(){
    try {
      // 로컬에 이미 찍혀 있으면 바로 잠금
      if (localStorage.getItem(LS_KEY) === '1') { lockButton(); return; }

      // 서버에도 물어보기 (다른 기기/브라우저에서 이미 받았을 수 있음)
      const r = await fetch(`/event/coupon/issued?eventCode=${encodeURIComponent(EVENT_CODE)}`, {
        headers: csrfToken ? { [csrfHeader]: csrfToken } : {}
      });
      if (r.ok) {
        const { issued } = await r.json();
        if (issued) {
          localStorage.setItem(LS_KEY, '1');
          lockButton();
        } else {
          unlockButton();
        }
      }
    } catch (e) {
      // 네트워크 오류 시엔 조용히 넘어감 (버튼은 기본 상태 유지)
    }
  })();

  // ===== 클릭 처리 (AJAX) =====
  $btn?.addEventListener('click', async () => {
    // 프론트 가드: 이미 발급 상태면 서버 안 가고 바로 안내
    if (localStorage.getItem(LS_KEY) === '1' || $btn.disabled) {
      openModal('이미 쿠폰을 발급받았습니다 🎁');
      return;
    }

    const trait = document.getElementById('traitVal')?.value || '';
    $btn.disabled = true;

    try {
      const headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
      if (csrfToken) headers[csrfHeader] = csrfToken;

      const res = await fetch('/event/test/issue-coupon', {
        method: 'POST',
        headers,
        body: new URLSearchParams({ trait })
      });

      if (res.status === 401) { location.href = '/login'; return; }

      let data = null;
      try { data = await res.json(); } catch(_) {}

      if (res.ok && data?.ok) {
        localStorage.setItem(LS_KEY, '1');
        lockButton();
        openModal(data.message || '쿠폰 발급이 완료되었습니다 🎁');
      } else {
        // 컨트롤러에서 중복 시 code=ALREADY_ISSUED 내려주도록 수정해둔 상태
        const code = data?.code || '';
        const msg  = data?.message || '';
        if (code === 'ALREADY_ISSUED' || /이미.*발급/.test(msg)) {
          localStorage.setItem(LS_KEY, '1');
          lockButton();
          openModal('이미 쿠폰을 발급받았습니다 🎁');
        } else {
          openModal(msg || '쿠폰 발급에 실패했습니다. 잠시 후 다시 시도해주세요.');
          $btn.disabled = false; // 실패 시 재시도 가능
        }
      }
    } catch (err) {
      openModal('네트워크 오류로 실패했습니다. 잠시 후 다시 시도해주세요.');
      $btn.disabled = false;
    }
  });
</script>
</body>
</html>