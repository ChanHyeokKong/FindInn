<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ì—¬í–‰ ì„±í–¥ ê²°ê³¼</title>

  <!-- âœ… CSRF (ìˆì„ ë•Œë§Œ) -->
  <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}">

  <!-- (ì„ íƒ) ë§í¬ ë¯¸ë¦¬ë³´ê¸°ìš© OG ë©”íƒ€ â€” ì„œë²„ì—ì„œ ê²°ê³¼ê°’ìœ¼ë¡œ ì±„ì›Œë„ ì¢‹ì•„ìš” -->
  <meta property="og:title" content="ì—¬í–‰ ì„±í–¥ ê²°ê³¼">
  <meta property="og:description" content="ë‚˜ì˜ ì—¬í–‰ ì„±í–¥ ì ìˆ˜ì™€ ì¶”ì²œ ìˆ™ì†Œ í™•ì¸í•˜ê¸°">
  <meta property="og:image" content="https://via.placeholder.com/1200x630.png?text=Travel+Result">
  <meta property="og:url" content="">

  <style>
    :root{
      --bg:#fbfcfe; --card:#ffffff; --ink:#0f172a; --muted:#64748b;
      --shadow:0 16px 40px rgba(15,23,42,.08); --r:18px;
      --bar-bg:#f0f4f9;
      /* Pastel+ (ë°ê³  ì„ ëª…) */
      --act1:#ff9b73; --act2:#ffd09b;
      --heal1:#34d399; --heal2:#a7f3d0;
      --chal1:#f472b6; --chal2:#fbcfe8;
      --emo1:#60a5fa; --emo2:#bfdbfe;
    }

    *{box-sizing:border-box}
    body{
      margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;
      color:var(--ink); background:var(--bg); padding:30px; text-align:center
    }

    /* ì¹´ë“œ + ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
    .card{
      max-width:820px; margin:0 auto; background:var(--card); border-radius:var(--r);
      box-shadow:var(--shadow); padding:32px;
      opacity:0; transform:translateY(8px); transition:opacity .45s ease, transform .45s ease;
    }
    .card.is-in{ opacity:1; transform:translateY(0); }

    h1{margin:0 0 6px;font-size:28px}
    .subtitle{margin:0 0 18px;color:var(--muted)}
    .desc{margin:8px 0 16px;color:#334155}
    .section-title{margin:18px 0 10px;font-weight:700}
    .row{margin:14px 0}
    .label{display:flex;justify-content:space-between;align-items:center;margin:0 auto 6px;width:82%}
    .label span:first-child{font-weight:600}
    .pill{font-size:12px;background:#eef2ff;color:#3730a3;border-radius:999px;padding:4px 8px}

    /* Bars */
    .bar-wrap{
      width:82%; height:14px; background:var(--bar-bg); border-radius:999px; margin:0 auto; overflow:hidden; position:relative
    }
    .bar-wrap::after{content:"";position:absolute;inset:0;border-radius:999px;box-shadow:inset 0 1px 0 rgba(255,255,255,.6)}
    .bar{height:100%}
    .bar.activity {background:linear-gradient(90deg,var(--act1),var(--act2))}
    .bar.healing  {background:linear-gradient(90deg,var(--heal1),var(--heal2))}
    .bar.challenge{background:linear-gradient(90deg,var(--chal1),var(--chal2))}
    .bar.emotion  {background:linear-gradient(90deg,var(--emo1),var(--emo2))}

    .recos{margin-top:18px}
    .recos ul{list-style:none;padding:0;margin:6px 0 0}
    .recos li{margin:6px 0;color:#475569}

    .ctl{margin-top:16px}
    .btn{
      display:inline-block; border:0; background:#2f6bff; color:#fff; padding:10px 14px; border-radius:10px;
      text-decoration:none; cursor:pointer; transition: transform .12s ease, box-shadow .2s ease;
    }
    .btn:hover{ transform: translateY{-1px}; box-shadow:0 8px 18px rgba(47,107,255,.18); }
    .btn:active{ transform: translateY(0); box-shadow:0 4px 10px rgba(47,107,255,.15); }
    .btn[disabled]{background:#93b0ff;cursor:not-allowed}

    /* --- Modal --- */
    .modal{position:fixed; inset:0; display:none; align-items:center; justify-content:center;
           background:rgba(15,23,42,.45); z-index:1000;}
    .modal.open{display:flex;}
    .modal-dialog{background:#fff; border-radius:16px; padding:22px 20px; width:min(92vw,420px);
                  box-shadow:var(--shadow); text-align:center}
    .modal-title{margin:0 0 6px; font-size:18px; font-weight:700}
    .modal-msg{margin:8px 0 14px; color:#334155}
    .modal-actions{display:flex; justify-content:center; gap:10px}
    .btn-outline{background:#fff; color:#1f2937; border:1px solid #e5e7eb; border-radius:10px; padding:8px 12px; cursor:pointer}

    /* ê³µìœ  ì˜ì—­ */
    .share{margin-top:18px; display:flex; gap:8px; justify-content:center; flex-wrap:wrap}
  </style>
</head>
<body>
<div class="card"
     th:with="levels=${levels != null ? levels : {'activity':0,'healing':0,'emotion':0,'challenge':0}}">
  <h1>ğŸ‰ ë‹¹ì‹ ì˜ ì—¬í–‰ ë¶€ìºëŠ”?</h1>
  <p class="subtitle"
     th:text="${character != null
               ? (character.name + (character.code != null ? ' (' + character.code + ')' : ''))
               : (#strings.capitalize(topTrait))}">
    ê²°ê³¼ëª… (ì½”ë“œ)
  </p>

  <p class="desc"
     th:text="${character != null && character.description != null ? character.description : 'ì„¤ëª…ì´ ì¤€ë¹„ì¤‘ì…ë‹ˆë‹¤.'}">
    ì„¤ëª…ë¬¸êµ¬
  </p>

  <h3 class="section-title">ğŸ“Š ëŠ¥ë ¥ì¹˜</h3>

  <!-- Activity -->
  <div class="row">
    <div class="label">
      <span>Activity</span>
      <span class="pill" th:text="${levels['activity']} + '%'">0%</span>
    </div>
    <div class="bar-wrap">
      <div class="bar activity" th:style="|width:${levels['activity']?:0}%|"></div>
    </div>
  </div>

  <!-- Healing -->
  <div class="row">
    <div class="label">
      <span>Healing</span>
      <span class="pill" th:text="${levels['healing']} + '%'">0%</span>
    </div>
    <div class="bar-wrap">
      <div class="bar healing" th:style="|width:${levels['healing']?:0}%|"></div>
    </div>
  </div>

  <!-- Challenge -->
  <div class="row">
    <div class="label">
      <span>Challenge</span>
      <span class="pill" th:text="${levels['challenge']} + '%'">0%</span>
    </div>
    <div class="bar-wrap">
      <div class="bar challenge" th:style="|width:${levels['challenge']?:0}%|"></div>
    </div>
  </div>

  <!-- Emotion -->
  <div class="row">
    <div class="label">
      <span>Emotion</span>
      <span class="pill" th:text="${levels['emotion']} + '%'">0%</span>
    </div>
    <div class="bar-wrap">
      <div class="bar emotion" th:style="|width:${levels['emotion']?:0}%|"></div>
    </div>
  </div>

  <!-- ì¶”ì²œ ìˆ™ì†Œ -->
  <div class="recos"
       th:if="${character != null && character.recommendedAccommodations != null && !#lists.isEmpty(character.recommendedAccommodations)}">
    <h3 class="section-title">ğŸ¨ ì¶”ì²œ ìˆ™ì†Œ</h3>
    <ul>
      <li th:each="acc : ${character.recommendedAccommodations}" th:text="${acc}">ìˆ™ì†Œ</li>
    </ul>
  </div>

  <!-- ì¿ í° ë²„íŠ¼ (AJAX + ëª¨ë‹¬) -->
  <div class="ctl" th:if="${topTrait != null}">
    <input type="hidden" id="traitVal" th:value="${topTrait}">
    <button type="button" id="btn-coupon" class="btn" data-event="event-test">ğŸ ì¿ í° ë°›ê¸°</button>
  </div>

  <!-- ê³µìœ  (ì¹´ì¹´ì˜¤ ì œê±°: ë§í¬ ê³µìœ  + ì´ë¯¸ì§€ ì €ì¥ë§Œ) -->
  <div class="share">
    <button type="button" class="btn" id="btnShareLink">ë§í¬ ë³µì‚¬</button>
    <button type="button" class="btn" id="btnSaveImage">ì´ë¯¸ì§€ ì €ì¥</button>
  </div>
</div>

<!-- Modal -->
<div id="couponModal" class="modal" aria-hidden="true" role="dialog" aria-labelledby="couponTitle">
  <div class="modal-dialog">
    <h4 id="couponTitle" class="modal-title">ì¿ í° ë°œê¸‰</h4>
    <p id="couponMsg" class="modal-msg">ì²˜ë¦¬ ì¤‘â€¦</p>
    <div class="modal-actions">
      <button type="button" id="modalClose" class="btn-outline">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- html2canvas (ì´ë¯¸ì§€ ì €ì¥ìš©) -->
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>

<script>
  // ===== CSRF =====
  const csrfToken  = document.querySelector('meta[name="_csrf"]')?.content || null;
  const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content || 'X-CSRF-TOKEN';

  // ===== Elements =====
  const $btn   = document.getElementById('btn-coupon');
  const $modal = document.getElementById('couponModal');
  const $msg   = document.getElementById('couponMsg');
  const $close = document.getElementById('modalClose');

  function openModal(text){ $msg.textContent = text; $modal.classList.add('open'); $modal.setAttribute('aria-hidden','false'); }
  function closeModal(){ $modal.classList.remove('open'); $modal.setAttribute('aria-hidden','true'); }
  $close?.addEventListener('click', closeModal);
  $modal?.addEventListener('click', (e)=>{ if(e.target === $modal) closeModal(); });
  document.addEventListener('keydown', (e)=>{ if(e.key === 'Escape') closeModal(); });

  const EVENT_CODE = $btn?.dataset.event || 'event-test';
  const LS_KEY = `coupon_issued:${EVENT_CODE}`;

  function lockButton(){
    if (!$btn) return;
    $btn.disabled = true;
    $btn.textContent = 'ë°œê¸‰ ì™„ë£Œ âœ…';
  }
  function unlockButton(){
    if (!$btn) return;
    $btn.disabled = false;
    $btn.textContent = 'ğŸ ì¿ í° ë°›ê¸°';
  }

  // ===== ì´ˆê¸° ë™ê¸°í™” (ì„œë²„ ìƒíƒœ í™•ì¸) =====
  (async function syncIssued(){
    try {
      if (localStorage.getItem(LS_KEY) === '1') { lockButton(); return; }
      const r = await fetch(`/event/coupon/issued?eventCode=${encodeURIComponent(EVENT_CODE)}`, {
        headers: csrfToken ? { [csrfHeader]: csrfToken } : {}
      });
      if (r.ok) {
        const { issued } = await r.json();
        if (issued) {
          localStorage.setItem(LS_KEY, '1');
          lockButton();
        } else {
          unlockButton();
        }
      }
    } catch (e) {
      // ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ëŠ” ì¡°ìš©íˆ íŒ¨ìŠ¤
    }
  })();

  // ===== í´ë¦­ ì²˜ë¦¬ (AJAX) =====
  $btn?.addEventListener('click', async () => {
    if (localStorage.getItem(LS_KEY) === '1' || $btn.disabled) {
      openModal('ì´ë¯¸ ì¿ í°ì„ ë°œê¸‰ë°›ì•˜ìŠµë‹ˆë‹¤ ğŸ');
      return;
    }

    const trait = document.getElementById('traitVal')?.value || '';
    $btn.disabled = true;

    try {
      const headers = { 'Content-Type': 'application/x-www-form-urlencoded' };
      if (csrfToken) headers[csrfHeader] = csrfToken;

      const res = await fetch('/event/test/issue-coupon', {
        method: 'POST',
        headers,
        body: new URLSearchParams({ trait })
      });

      if (res.status === 401) { location.href = '/login'; return; }

      let data = null;
      try { data = await res.json(); } catch(_) {}

      if (res.ok && data?.ok) {
        localStorage.setItem(LS_KEY, '1');
        lockButton();
        openModal(data.message || 'ì¿ í° ë°œê¸‰ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ');
      } else {
        const code = data?.code || '';
        const msg  = data?.message || '';
        if (code === 'ALREADY_ISSUED' || /ì´ë¯¸.*ë°œê¸‰/.test(msg)) {
          localStorage.setItem(LS_KEY, '1');
          lockButton();
          openModal('ì´ë¯¸ ì¿ í°ì„ ë°œê¸‰ë°›ì•˜ìŠµë‹ˆë‹¤ ğŸ');
        } else {
          openModal(msg || 'ì¿ í° ë°œê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
          $btn.disabled = false;
        }
      }
    } catch (err) {
      openModal('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
      $btn.disabled = false;
    }
  });

  // ===== ì¹´ë“œ ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ =====
  (function revealCard(){
    const card = document.querySelector('.card');
    if (!card) return;
    const io = new IntersectionObserver((entries, ob) => {
      entries.forEach(e => {
        if (e.isIntersecting) { card.classList.add('is-in'); ob.disconnect(); }
      });
    }, { threshold: .3 });
    io.observe(card);
  })();

  // ===== ëŠ¥ë ¥ì¹˜ ë°” ì• ë‹ˆë©”ì´ì…˜ (ê°œì„  ë²„ì „) =====
  (function animateBarsOnView(){
    const bars = document.querySelectorAll('.bar-wrap .bar');
    if (!bars.length) return;

    const io = new IntersectionObserver((entries, ob) => {
      entries.forEach(e => {
        if (!e.isIntersecting) return;
        const el = e.target;

        // th:styleë¡œ ì£¼ì…ëœ width ê°’ ì¶”ì¶œ
        const m = (el.getAttribute('style') || '').match(/width:\s*([\d.]+)%/);
        const target = m ? m[1] : '0';

        // 0%ì—ì„œ ì‹œì‘ + transition ìœ ì§€
        el.style.width = '0%';
        el.style.transition = 'width .9s cubic-bezier(.22,.61,.36,1)';

        requestAnimationFrame(() => {
          el.style.width = target + '%';
        });

        ob.unobserve(el);
      });
    }, { threshold: 0.35 });

    bars.forEach(b => io.observe(b));
  })();

  // ===== ê³µìœ : ë§í¬ ë³µì‚¬ + ì´ë¯¸ì§€ ì €ì¥ =====
  const pageUrl = window.location.href;
  document.getElementById('btnShareLink')?.addEventListener('click', async () => {
    const resultTitle = document.querySelector('h1')?.innerText || 'ì—¬í–‰ ì„±í–¥ ê²°ê³¼';
    const resultDesc  = document.querySelector('.desc')?.innerText || 'ë‚˜ì˜ ì—¬í–‰ ì„±í–¥ì„ í™•ì¸í•´ë³´ì„¸ìš”';
    const shareData = { title: resultTitle, text: resultDesc, url: pageUrl };

    if (navigator.share) {
      try { await navigator.share(shareData); return; } catch(e) {/* ì·¨ì†Œ ë“± ë¬´ì‹œ */ }
    }
    try {
      await navigator.clipboard.writeText(pageUrl);
      alert('ë§í¬ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤.');
    } catch(e) {
      prompt('ì•„ë˜ ë§í¬ë¥¼ ë³µì‚¬í•˜ì„¸ìš”.', pageUrl);
    }
  });

  document.getElementById('btnSaveImage')?.addEventListener('click', async () => {
    const card = document.querySelector('.card');
    if (!card) return;
    const canvas = await html2canvas(card, { backgroundColor: '#ffffff', scale: 2 });
    const link = document.createElement('a');
    link.download = 'travel-result.png';
    link.href = canvas.toDataURL('image/png');
    link.click();
  });
</script>
</body>
</html>
