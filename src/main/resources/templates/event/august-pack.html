<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org" lang="ko">
<head>
  <meta charset="UTF-8"/>
  <title>8ì›” ì¿ í°íŒ© ì´ë²¤íŠ¸</title>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>

  <!-- âœ… CSRF (ìŠ¤í”„ë§ ë³´ì•ˆ ì‚¬ìš© ì‹œ) -->
  <meta name="_csrf" th:if="${_csrf != null}" th:content="${_csrf.token}">
  <meta name="_csrf_header" th:if="${_csrf != null}" th:content="${_csrf.headerName}">

  <style>
    :root{
      --bg:#fbfcfe; --card:#ffffff; --ink:#0f172a; --muted:#667085;
      --coral:#ff4d57; --coral-200:#ffd7db; --blue:#2f6bff; --blue-200:#e7eeff;
      --shadow:0 16px 40px rgba(15,23,42,.08); --r:20px;
    }
    *{box-sizing:border-box}
    body{margin:0;font-family:ui-sans-serif,-apple-system,Segoe UI,Roboto,'Noto Sans KR',sans-serif;color:var(--ink);background:var(--bg)}
    .wrap{max-width:1040px;margin:28px auto;padding:0 16px}

    /* Hero */
    .hero{border-radius:28px;box-shadow:var(--shadow);overflow:hidden;background:linear-gradient(120deg,var(--blue-200),#fff);padding:26px 22px;display:flex;align-items:center;justify-content:space-between;gap:16px}
    .ribbon{display:inline-block;background:var(--coral);color:#fff;border-radius:999px;padding:8px 14px;font-weight:900;font-size:13px}
    .hero h1{margin:10px 0 6px;font-size:34px;line-height:1.08;letter-spacing:-.4px;font-weight:900}
    .count{font-size:13px;color:#b42318;font-weight:800;margin-top:6px}
    .btn{border:0;padding:12px 18px;border-radius:14px;font-weight:900;cursor:pointer}
    .btn-primary{background:var(--coral);color:#fff;box-shadow:0 10px 18px rgba(255,77,87,.22)}
    .btn[disabled]{background:#e5e7eb;color:#94a3b8;cursor:not-allowed}

    /* Banner */
    .banner{display:grid;grid-template-columns:140px 1fr auto;gap:18px;background:var(--card);border-radius:24px;box-shadow:var(--shadow);padding:20px 22px;margin-top:16px;align-items:center}
    @media(max-width:820px){.banner{grid-template-columns:120px 1fr;grid-auto-rows:auto}.banner form{grid-column:1/-1;justify-self:end}}
    .bignum{width:140px;height:86px;border:2px dashed var(--coral-200);border-radius:16px;background:#fff;display:flex;align-items:center;justify-content:center;font-weight:1000;font-size:46px;letter-spacing:-.8px;background-clip:text;-webkit-background-clip:text;color:transparent;background-image:linear-gradient(180deg,var(--coral),var(--blue));text-shadow:0 1px 0 rgba(0,0,0,.06);line-height:1}
    /* ê¸´ í…ìŠ¤íŠ¸(â‚©5,000) ëŒ€ë¹„ */
    .bignum--won{font-size:34px;letter-spacing:-.4px;padding:0 6px}
    .line1{font-weight:900;font-size:18px}
    .line2,.line3{color:var(--muted);font-size:13px;line-height:1.45;margin-top:3px}
    .tag{display:inline-flex;align-items:center;gap:6px;background:#eaffef;border:1px solid #22c55e;color:#137a37;padding:2px 8px;border-radius:999px;font-weight:800;font-size:11px;margin-left:6px}

    .sep{height:1px;background:linear-gradient(90deg,transparent,#e6e9ef,transparent);margin:22px 0}

    /* í˜¸í…” ì¹´ë“œ (ë¶„ë¦¬ ë°°ë„ˆ) */
    .hotel{display:flex;gap:18px;align-items:center;background:#f3f8ff;border-radius:24px;box-shadow:var(--shadow);padding:18px;margin-top:16px}
    .hotel img{width:48%;max-height:240px;object-fit:cover;border-radius:16px}
    .hotel .info{flex:1}
    .pill{display:inline-flex;align-items:center;gap:6px;background:#eef3ff;color:#2c6cff;padding:6px 10px;border-radius:999px;font-weight:800;font-size:12px}
  </style>
</head>
<body>
<div class="wrap">

  <!-- HERO -->
  <section class="hero">
    <div>
      <span class="ribbon">8ì›”ê¹Œì§€ ì­‰ ìˆ™ì†Œ ìµœëŒ€í• ì¸! âœˆï¸</span>
      <h1>ìˆ™ì†Œ <span style="color:var(--coral)">ìµœëŒ€ 10%</span> ì¿ í°íŒ© ğŸ–ï¸</h1>
      <div class="foot" style="color:var(--muted);font-size:12px">ì¿ í° í˜œíƒì€ ìˆ™ì†Œ/ì²´í¬ì¸ ê¸°ê°„/ì ìš© ì‹œì ì— ë”°ë¼ ë‹¬ë¼ì§ˆ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</div>
      <div class="count" id="issue-count" th:text="'í˜„ì¬ ë°œê¸‰ : ' + (${issuedCount}?:0) + ' / 3'">í˜„ì¬ ë°œê¸‰ : 0 / 3</div>
    </div>
    <!-- ê¸°ë³¸ í¼ì€ ë³´ì¡´(í”„ë¡œê·¸ë ˆì‹œë¸Œ)í•˜ì§€ë§Œ JSê°€ ê°€ë¡œì±„ì„œ JSON í˜¸ì¶œ -->
    <form class="coupon-form" th:action="@{/event/coupon/issue-by-code}" method="post" data-code="AUG_7P">
      <input type="hidden" name="code" value="AUG_7P"/>
      <div th:if="${_csrf} != null">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
      </div>
      <button class="btn btn-primary" type="submit"
              th:disabled="${issuedCodes?.contains('AUG_7P') or ((issuedCount ?: 0) >= 3)}"
              th:text="${issuedCodes?.contains('AUG_7P')} ? 'ë°œê¸‰ ì™„ë£Œ âœ…' : 'ì¿ í°íŒ© ë‹¤ìš´ë°›ê¸° ğŸ“¥'">ì¿ í°íŒ© ë‹¤ìš´ë°›ê¸° ğŸ“¥</button>
    </form>
  </section>

  <!-- 7% -->
  <article class="banner">
    <div class="bignum">7%</div>
    <div>
      <div class="line1">ìˆ™ì†Œ 7% í• ì¸ ğŸ‰</div>
      <div class="line2">8ë§Œì› ì´ìƒ Â· ìµœëŒ€ 20,000ì›</div>
      <div class="line3">ì‚¬ìš©ê¸°ê°„: ë°œê¸‰ì¼ë¡œë¶€í„° 10ì¼ (8/31 ë§Œë£Œ)</div>
    </div>
    <form class="coupon-form" th:action="@{/event/coupon/issue-by-code}" method="post" data-code="AUG_7P">
      <input type="hidden" name="code" value="AUG_7P"/>
      <div th:if="${_csrf} != null">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
      </div>
      <button class="btn btn-primary" type="submit"
              th:disabled="${issuedCodes?.contains('AUG_7P') or ((issuedCount ?: 0) >= 3)}"
              th:text="${issuedCodes?.contains('AUG_7P')} ? 'ë°œê¸‰ ì™„ë£Œ âœ…' : 'ë°œê¸‰ë°›ê¸°'">ë°œê¸‰ë°›ê¸°</button>
    </form>
  </article>

  <!-- 10% -->
  <article class="banner">
    <div class="bignum" style="background-image:linear-gradient(180deg,var(--blue),#6aa2ff)">10%</div>
    <div>
      <div class="line1">ìˆ™ì†Œ 10% í• ì¸ ğŸš€</div>
      <div class="line2">12ë§Œì› ì´ìƒ Â· ìµœëŒ€ 40,000ì›</div>
      <div class="line3">ì‚¬ìš©ê¸°ê°„: ë°œê¸‰ì¼ë¡œë¶€í„° 10ì¼ (8/31 ë§Œë£Œ)</div>
    </div>
    <form class="coupon-form" th:action="@{/event/coupon/issue-by-code}" method="post" data-code="AUG_10P">
      <input type="hidden" name="code" value="AUG_10P"/>
      <div th:if="${_csrf} != null">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
      </div>
      <button class="btn btn-primary" type="submit"
              th:disabled="${issuedCodes?.contains('AUG_10P') or ((issuedCount ?: 0) >= 3)}"
              th:text="${issuedCodes?.contains('AUG_10P')} ? 'ë°œê¸‰ ì™„ë£Œ âœ…' : 'ë°œê¸‰ë°›ê¸°'">ë°œê¸‰ë°›ê¸°</button>
    </form>
  </article>

  <!-- 5,000ì› -->
  <article class="banner">
    <div class="bignum bignum--won">â‚©5,000</div>
    <div>
      <div class="line1">ì—¬ë¦„íœ´ê°€ ì§€ì›ê¸ˆ ğŸŒ´ <span class="tag">STACK ê°€ëŠ¥</span></div>
      <div class="line2">ì „í˜¸í…” ì‚¬ìš©</div>
      <div class="line3">ë‹¤ë¥¸ ì¿ í°ê³¼ ì¤‘ë³µ ì‚¬ìš© ê°€ëŠ¥</div>
    </div>
    <form class="coupon-form" th:action="@{/event/coupon/issue-by-code}" method="post" data-code="SUMMER_5K">
      <input type="hidden" name="code" value="SUMMER_5K"/>
      <div th:if="${_csrf} != null">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
      </div>
      <button class="btn btn-primary" type="submit"
              th:disabled="${issuedCodes?.contains('SUMMER_5K') or ((issuedCount ?: 0) >= 3)}"
              th:text="${issuedCodes?.contains('SUMMER_5K')} ? 'ë°œê¸‰ ì™„ë£Œ âœ…' : 'ë°œê¸‰ë°›ê¸°'">ë°œê¸‰ë°›ê¸°</button>
    </form>
  </article>

  <div class="sep"></div>

  <!-- ì§€ì • í˜¸í…” 20% -->
  <article class="banner" style="background:linear-gradient(120deg,#fff,var(--blue-200))">
    <div class="bignum" style="background-image:linear-gradient(180deg,#1b51ff,#73a2ff)">20%</div>
    <div>
      <div class="line1">ì§€ì • í˜¸í…” 20% í• ì¸ ğŸ¨</div>
      <div class="line2">ì§€ì • í˜¸í…” í•œì • Â· ì¤‘ë³µ ì ìš© ë¶ˆê°€</div>
      <div class="line3">ì‚¬ìš©ê¸°ê°„: ë°œê¸‰ì¼ë¡œë¶€í„° 10ì¼ (8/31 ë§Œë£Œ)</div>
    </div>
    <form class="coupon-form" th:action="@{/event/coupon/issue-by-code}" method="post" data-code="HOTEL_20P">
      <input type="hidden" name="code" value="HOTEL_20P"/>
      <div th:if="${_csrf} != null">
        <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}">
      </div>
      <button class="btn btn-primary" type="submit"
              th:disabled="${issuedCodes?.contains('HOTEL_20P') or ((issuedCount ?: 0) >= 3)}"
              th:text="${issuedCodes?.contains('HOTEL_20P')} ? 'ë°œê¸‰ ì™„ë£Œ âœ…' : 'ë°œê¸‰ë°›ê¸°'">ë°œê¸‰ë°›ê¸°</button>
    </form>
  </article>

  <!-- í˜¸í…” ì¹´ë“œ (ë¶„ë¦¬) -->
  <div class="hotel">
    <img src="https://images.unsplash.com/photo-1528909514045-2fa4ac7a08ba?q=80&w=1600&auto=format&fit=crop" alt="í˜¸í…”ì•„ì¿ ë¼í ë¦¬ìŠ¤ ì´ë¯¸ì§€">
    <div class="info">
      <h3 style="margin:0 0 6px">í˜¸í…”ì•„ì¿ ë¼í ë¦¬ìŠ¤</h3>
      <span class="pill">ğŸ“ ë¶€ì‚° Â· 20% OFF</span>
      <ul style="margin:10px 0 0 18px;padding:0;color:#334155;font-size:14px">
        <li>ì•„ëŠ‘í•œ ê°ì‹¤ê³¼ í¸ì•ˆí•œ ì¹¨êµ¬</li>
        <li>ë„ì‹¬ ì ‘ê·¼ì„± ì¢‹ì€ ìœ„ì¹˜</li>
      </ul>
      <div style="margin-top:12px">
        <a class="btn" style="background:#2f6bff;color:#fff;text-decoration:none" th:href="@{/hotel/{id}(id=${hotelId}?:123)}">í˜¸í…” ë°”ë¡œë³´ê¸° &gt;</a>
      </div>
    </div>
  </div>
</div>

<!-- âœ… AJAX ì²˜ë¦¬ ìŠ¤í¬ë¦½íŠ¸ -->
<script>
(function(){
  const EVENT_CODE = 'august-pack'; // ì„œë²„ ì»¨íŠ¸ë¡¤ëŸ¬ ìƒìˆ˜ì™€ ì¼ì¹˜
  const csrfToken = document.querySelector('meta[name="_csrf"]')?.content ?? '';
  const csrfHeader = document.querySelector('meta[name="_csrf_header"]')?.content ?? 'X-CSRF-TOKEN';
  const $count = document.getElementById('issue-count');

  // ê°„ë‹¨ í† ìŠ¤íŠ¸ (í”„ë¡œì íŠ¸ì˜ ëª¨ë‹¬/í† ìŠ¤íŠ¸ë¡œ êµì²´í•´ë„ ë¨)
  function toast(msg){ alert(msg); }

  // ë²„íŠ¼ ì ê·¸ê¸° + í…ìŠ¤íŠ¸ ë³€ê²½
  function lockButton(btn){
    btn.disabled = true;
    btn.textContent = 'ë°œê¸‰ ì™„ë£Œ âœ…';
  }

  // ì¹´ìš´íŠ¸ +1 (ìµœëŒ€ 3)
  function bumpCount(){
    if (!$count) return;
    const m = $count.textContent.match(/í˜„ì¬ ë°œê¸‰\s*:\s*(\d+)\s*\/\s*3/);
    if (!m) return;
    let n = parseInt(m[1] || '0', 10);
    if (n < 3) n++;
    $count.textContent = `í˜„ì¬ ë°œê¸‰ : ${n} / 3`;
  }

  // í˜ì´ì§€ ì§„ì… ì‹œ ì„œë²„ì™€ 1íšŒ ë™ê¸°í™” (ë‹¤ë¥¸ ê¸°ê¸°ì—ì„œ ì´ë¯¸ ë°›ì•˜ì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ)
  (async function syncIssued(){
    try{
      const r = await fetch(`/event/coupon/issued?eventCode=${encodeURIComponent(EVENT_CODE)}`, {
        headers: { [csrfHeader]: csrfToken }
      });
      if (!r.ok) return;
      const { issued } = await r.json();
      if (issued) {
        // ì´ë¯¸ ë°œê¸‰ëœ ì¿ í°ë“¤ì˜ ë²„íŠ¼ì„ SSRì´ disabledë¡œ ì²˜ë¦¬í–ˆì„ ê²ƒì´ë¯€ë¡œ ì¶”ê°€ ì¡°ì¹˜ëŠ” ë¶ˆí•„ìš”.
        // (í•„ìš”í•˜ë©´ ì—¬ê¸°ì„œë„ ë²„íŠ¼ ìƒíƒœë¥¼ ë‹¤ì‹œ ìŠ¤ìº”í•´ ì ê¸€ ìˆ˜ ìˆìŒ)
      }
    }catch(e){ /* ignore */ }
  })();

  // ëª¨ë“  ì¿ í° í¼ì„ AJAXë¡œ ê°€ë¡œì±„ê¸°
  document.querySelectorAll('form.coupon-form').forEach(form=>{
    form.addEventListener('submit', async (e)=>{
      e.preventDefault();

      const btn = form.querySelector('button[type="submit"]');
      if (!btn || btn.disabled) return;

      const code = form.dataset.code || form.querySelector('input[name="code"]')?.value || '';
      if (!code) return;

      // ì„œë²„ JSON ì—”ë“œí¬ì¸íŠ¸ í˜¸ì¶œ
      try{
        btn.disabled = true; // ì¤‘ë³µ í´ë¦­ ë°©ì§€
        const r = await fetch('/event/coupon/issue-by-code.json', {
          method: 'POST',
          headers: {
            'Content-Type':'application/x-www-form-urlencoded',
            [csrfHeader]: csrfToken
          },
          body: new URLSearchParams({ code })
        });

        const res = await r.json().catch(()=> ({}));

        if (r.ok && res.ok){
          lockButton(btn);
          bumpCount();
          toast(res.message || 'ì¿ í°ì´ ë°œê¸‰ë˜ì—ˆìŠµë‹ˆë‹¤ ğŸ');
        } else {
          // ì»¨íŠ¸ë¡¤ëŸ¬ì—ì„œ ALREADY_ISSUED ë¥¼ ë‚´ë ¤ì£¼ë„ë¡ ìˆ˜ì •í•´ë‘” ìƒíƒœ
          if (res.code === 'ALREADY_ISSUED' || /ì´ë¯¸.*ë°œê¸‰/.test(res.message || '')) {
            lockButton(btn);
            toast('ì´ë¯¸ ì¿ í°ì„ ë°œê¸‰ë°›ì•˜ìŠµë‹ˆë‹¤ ğŸ');
          } else {
            // ì‹¤íŒ¨ ì‹œ ë²„íŠ¼ ë³µêµ¬
            btn.disabled = false;
            toast(res.message || 'ì¿ í° ë°œê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
          }
        }
      } catch(err){
        btn.disabled = false;
        toast('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ë¡œ ë°œê¸‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
      }
    });
  });
})();
</script>
</body>
</html>
