<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title>숙소 정보 수정</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/froala-editor@4.2.0/css/froala_editor.pkgd.min.css" rel="stylesheet">
    <style>
        .room-card {
            border: 1px solid #dee2e6;
            border-radius: .375rem;
            padding: 1.5rem;
            margin-bottom: 1rem;
            background-color: #f8f9fa;
        }
        .image-upload-box {
            width: 100%;
            height: 180px;
            border: 2px dashed #ccc;
            border-radius: 5px;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #fff;
            color: #aaa;
            font-size: 1rem;
            cursor: pointer;
            text-align: center;
            transition: background-color 0.2s, border-color 0.2s;
            overflow: hidden; /* Ensures the image fits within the border-radius */
        }
        .image-upload-box:hover {
            background-color: #f8f9fa;
            border-color: #0d6efd;
        }
        .image-upload-box img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
    </style>
</head>
<body>

<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-12">
            <h1 class="mb-4 text-center">숙소 정보 수정</h1>

            <!-- The form now points to the edit endpoint and is bound to the 'hotel' object -->
            <form th:action="@{/edit/{id}(id=${hotel.idx})}" th:object="${hotel}" method="post" enctype="multipart/form-data">
                <input type="hidden" th:field="*{idx}" />

                <div class="row">
                    <!-- Main Hotel Image -->
                    <div class="col-md-4">
                        <div class="mb-3">
                            <label class="form-label">숙소 대표 사진</label>
                            <!-- The box now displays the existing image -->
                            <div class="image-upload-box" id="main-upload-box" onclick="document.getElementById('new-main-image-file').click();" style="height: 300px;">
                                <img th:if="*{hotelImage != null}"
                                     th:src="@{'/uploads/hotels/' + ${hotel.hotelImage}}"
                                     alt="대표 사진"/>
                                <span th:unless="*{hotelImage != null}"><i class="fa fa-camera fa-2x"></i><br>클릭하여 대표 사진 추가</span>
                            </div>
                            <!-- This input is for uploading a NEW image -->
                            <input class="d-none" type="file" id="new-main-image-file" name="newHotelImageFile" accept="image/*">
                        </div>
                    </div>

                    <!-- Basic Hotel Info -->
                    <div class="col-md-7">
                        <div class="mb-3">
                            <label for="hotel_name" class="form-label">숙소명</label>
                            <input type="text" class="form-control" id="hotel_name" th:field="*{hotelName}" required>
                        </div>
                        <div class="mb-3">
                            <label for="phone_number" class="form-label">전화번호</label>
                            <input type="text" class="form-control" id="phone_number" th:field="*{hotelTel}" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">주소</label>
                            <div class="input-group mb-2">
                                <input type="text" id="postcode" class="form-control" placeholder="우편번호" readonly>
                                <button class="btn btn-outline-secondary" type="button" onclick="execDaumPostcode()">우편번호 찾기</button>
                            </div>
                            <!-- The main address field is now bound -->
                            <input type="text" id="address" th:field="*{hotelAddress}" class="form-control mb-2" placeholder="주소" readonly>
                            <input type="text" id="detailAddress" class="form-control" placeholder="상세주소">
                        </div>
                    </div>
                </div>
                <hr>

                <!-- Categories -->
                <div class="mb-4">
                    <h5 class="mb-2">카테고리</h5>
                    <div class="d-flex flex-wrap gap-2">
                        <input type="radio" class="btn-check" th:field="*{hotelCategory}" value="motel" id="cat_motel"><label class="btn btn-outline-primary" for="cat_motel">모텔</label>
                        <input type="radio" class="btn-check" th:field="*{hotelCategory}" value="hotel&resort" id="cat_hotel"><label class="btn btn-outline-primary" for="cat_hotel">호텔·리조트</label>
                        <input type="radio" class="btn-check" th:field="*{hotelCategory}" value="pension" id="cat_pension"><label class="btn btn-outline-primary" for="cat_pension">펜션</label>
                        <input type="radio" class="btn-check" th:field="*{hotelCategory}" value="home&villa" id="cat_home"><label class="btn btn-outline-primary" for="cat_home">홈&빌라</label>
                        <input type="radio" class="btn-check" th:field="*{hotelCategory}" value="camping" id="cat_camping"><label class="btn btn-outline-primary" for="cat_camping">캠핑</label>
                        <input type="radio" class="btn-check" th:field="*{hotelCategory}" value="guesthouse" id="cat_guesthouse"><label class="btn btn-outline-primary" for="cat_guesthouse">게하·한옥</label>
                    </div>
                </div>

                <!-- Tags and Facilities -->
                <div th:object="${hotel.tags}">
                    <div class="mb-4">
                        <h5 class="mb-2">#취향</h5>
                        <div class="d-flex flex-wrap gap-2">
                            <input type="checkbox" class="btn-check" id="tag_family" name="tags.family" th:checked="*{family}"/><label class="btn btn-outline-success" for="tag_family">#가족여행숙소</label>
                            <input type="checkbox" class="btn-check" id="tag_waterpool" name="tags.waterpool" th:checked="*{waterpool}"/><label class="btn btn-outline-success" for="tag_waterpool">#온수풀</label>
                            <input type="checkbox" class="btn-check" id="tag_view" name="tags.view" th:checked="*{view}"/><label class="btn btn-outline-success" for="tag_view">#뷰맛집</label>
                            <input type="checkbox" class="btn-check" id="tag_beach" name="tags.beach" th:checked="*{beach}"/><label class="btn btn-outline-success" for="tag_beach">#바닷가</label>
                            <input type="checkbox" class="btn-check" id="tag_nicemeal" name="tags.nicemeal" th:checked="*{nicemeal}"/><label class="btn btn-outline-success" for="tag_nicemeal">#조식맛집</label>
                        </div>
                    </div>
                    <div class="mb-4">
                        <h5 class="mb-2">시설</h5>
                        <div class="d-flex flex-wrap gap-2">
                            <input type="checkbox" class="btn-check" id="fac_sauna" name="tags.sauna" th:checked="*{sauna}"/><label class="btn btn-outline-secondary" for="fac_sauna">사우나</label>
                            <input type="checkbox" class="btn-check" id="fac_swimming_pool" name="tags.swimming_pool" th:checked="*{swimming_pool}"/><label class="btn btn-outline-secondary" for="fac_swimming_pool">수영장</label>
                            <input type="checkbox" class="btn-check" id="fac_restaurant" name="tags.restaurant" th:checked="*{restaurant}"/><label class="btn btn-outline-secondary" for="fac_restaurant">레스토랑</label>
                            <input type="checkbox" class="btn-check" id="fac_fitness" name="tags.fitness" th:checked="*{fitness}"/><label class="btn btn-outline-secondary" for="fac_fitness">피트니스</label>
                            <input type="checkbox" class="btn-check" id="fac_golf" name="tags.golf" th:checked="*{golf}"/><label class="btn btn-outline-secondary" for="fac_golf">골프장</label>
                            <input type="checkbox" class="btn-check" id="fac_pc" name="tags.pc" th:checked="*{pc}"/><label class="btn btn-outline-secondary" for="fac_pc">공용PC</label>
                            <input type="checkbox" class="btn-check" id="fac_kitchen" name="tags.kitchen" th:checked="*{kitchen}"/><label class="btn btn-outline-secondary" for="fac_kitchen">주방/식당</label>
                            <input type="checkbox" class="btn-check" id="fac_washing_machine" name="tags.washing_Machine" th:checked="*{washing_Machine}"/><label class="btn btn-outline-secondary" for="fac_washing_machine">세탁기</label>
                            <input type="checkbox" class="btn-check" id="fac_parking" name="tags.parking" th:checked="*{parking}"/><label class="btn btn-outline-secondary" for="fac_parking">주차장</label>
                            <input type="checkbox" class="btn-check" id="fac_spa" name="tags.spa" th:checked="*{spa}"/><label class="btn btn-outline-secondary" for="fac_spa">온천</label>
                            <input type="checkbox" class="btn-check" id="fac_ski" name="tags.ski" th:checked="*{ski}"/><label class="btn btn-outline-secondary" for="fac_ski">스키장</label>
                            <input type="checkbox" class="btn-check" id="fac_in_room_eating" name="tags.in_Room_Eating" th:checked="*{in_Room_Eating}"/><label class="btn btn-outline-secondary" for="fac_in_room_eating">객실내취사</label>
                            <input type="checkbox" class="btn-check" id="fac_breakfast" name="tags.breakfast" th:checked="*{breakfast}"/><label class="btn btn-outline-secondary" for="fac_breakfast">조식제공</label>
                            <input type="checkbox" class="btn-check" id="fac_smoking" name="tags.smoking" th:checked="*{smoking}"/><label class="btn btn-outline-secondary" for="fac_smoking">객실내흡연</label>
                            <input type="checkbox" class="btn-check" id="fac_luggage" name="tags.luggage" th:checked="*{luggage}"/><label class="btn btn-outline-secondary" for="fac_luggage">짐보관가능</label>
                            <input type="checkbox" class="btn-check" id="fac_disabled" name="tags.disabled" th:checked="*{disabled}"/><label class="btn btn-outline-secondary" for="fac_disabled">장애인편의</label>
                            <input type="checkbox" class="btn-check" id="fac_pickup" name="tags.pickup" th:checked="*{pickup}"/><label class="btn btn-outline-secondary" for="fac_pickup">픽업서비스</label>
                        </div>
                    </div>
                </div>

                <!-- Room Types Section -->
                <div class="mb-4">
                    <div class="d-flex justify-content-between align-items-center mb-2">
                        <h5>객실 타입</h5>
                        <button type="button" class="btn btn-success" onclick="addRoomCard()">
                            <i class="fa fa-plus"></i> 추가
                        </button>
                    </div>
                    <div id="room-cards-container">
                        <div th:each="room, iterStat : *{roomTypes}" class="room-card" th:id="'room-card-' + ${iterStat.index}">
                            <div class="d-flex justify-content-end mb-2">
                                <button type="button" class="btn-close" aria-label="Close" th:onclick="'deleteRoomCard(\'room-card-' + ${iterStat.index} + '\')'"></button>
                            </div>
                            <input type="hidden" th:field="*{roomTypes[__${iterStat.index}__].idx}" />
                            <input type="hidden" th:field="*{roomTypes[__${iterStat.index}__].imageUrl}" />

                            <div class="row">
                                <div class="col-md-4">
                                    <label class="form-label">객실 사진</label>
                                    <input type="file" class="form-control d-none" th:id="'room-image-input-' + ${iterStat.index}" th:name="|roomTypes[${iterStat.index}].imageFile|" accept="image/*" th:onchange="'previewRoomImage(event, \'room-image-preview-' + ${iterStat.index} + '\')'">
                                    <div th:id="'room-image-preview-' + ${iterStat.index}" class="image-upload-box" th:onclick="'document.getElementById(\'room-image-input-' + ${iterStat.index} + '\').click();'">
                                        <img th:if="${room.imageUrl != null}"
                                             th:src="@{'/uploads/hotels/' + ${room.imageUrl}}"
                                             alt="Room image preview"/>
                                        <span th:unless="${room.imageUrl != null}"><i class='fa fa-image'></i><br>클릭하여 사진 추가</span>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    <div class="mb-3">
                                        <label class="form-label">객실명</label>
                                        <input type="text" class="form-control" th:field="*{roomTypes[__${iterStat.index}__].typeName}" required>
                                    </div>
                                    <div class="mb-3">
                                        <label class="form-label">객실 설명</label>
                                        <textarea class="form-control" th:field="*{roomTypes[__${iterStat.index}__].description}" rows="2"></textarea>
                                    </div>
                                    <div class="row">
                                        <div class="col-sm-6 mb-3">
                                            <label class="form-label">가격 (1박)</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" th:field="*{roomTypes[__${iterStat.index}__].price}" required>
                                                <span class="input-group-text">원</span>
                                            </div>
                                        </div>
                                        <div class="col-sm-6 mb-3">
                                            <label class="form-label">최대 인원</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" th:field="*{roomTypes[__${iterStat.index}__].capacity}" required>
                                                <span class="input-group-text">명</span>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <hr>

                <!-- Description -->
                <div class="mb-4">
                    <h5 class="mb-2">숙소 소개</h5>
                </div>
                <!-- Set initial content for Froala editor from the model -->
                <textarea id="desc" th:field="*{description}" th:text="*{description}"></textarea>

                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">수정하기</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script src="//t1.daumcdn.net/mapjsapi/bundle/postcode/prod/postcode.v2.js"></script>
<script src="https://cdn.jsdelivr.net/npm/froala-editor@4.2.0/js/froala_editor.pkgd.min.js"></script>
<script th:inline="javascript">
    // Daum Postcode
    function execDaumPostcode() {
        new daum.Postcode({
            oncomplete: function(data) {
                var addr = (data.userSelectedType === 'R') ? data.roadAddress : data.jibunAddress;
                document.getElementById('postcode').value = data.zonecode;
                document.getElementById("address").value = addr;
                document.getElementById("detailAddress").focus();
            }
        }).open();
    }
    // Froala Editor
    new FroalaEditor('#desc', { height: 400 });

    // Main Image Preview
    document.getElementById('new-main-image-file').addEventListener('change', function(event) {
        const mainUploadBox = document.getElementById('main-upload-box');
        const file = event.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                mainUploadBox.innerHTML = `<img src="${e.target.result}" alt="새 대표 사진 프리뷰">`;
            };
            reader.readAsDataURL(file);
        }
    });

    // --- Dynamic Room Card Logic ---
    const roomCardsContainer = document.getElementById('room-cards-container');
    // Initialize roomIndex based on the number of existing rooms
    let roomIndex = /*[[${#lists.size(hotel.roomTypes)}]]*/ 0;

    function addRoomCard() {
        const cardId = `room-card-${roomIndex}`;
        const imageInputId = `room-image-input-${roomIndex}`;
        const imagePreviewId = `room-image-preview-${roomIndex}`;

        const cardHtml = `
            <div class="room-card" id="${cardId}">
                <div class="d-flex justify-content-end mb-2">
                    <button type="button" class="btn-close" aria-label="Close" onclick="deleteRoomCard('${cardId}')"></button>
                </div>
                <div class="row">
                    <div class="col-md-4">
                        <label for="${imageInputId}" class="form-label">객실 사진</label>
                        <input type="file" class="form-control d-none" id="${imageInputId}" name="roomTypes[${roomIndex}].imageFile" accept="image/*" onchange="previewRoomImage(event, '${imagePreviewId}')">
                        <div id="${imagePreviewId}" class="image-upload-box" onclick="document.getElementById('${imageInputId}').click();">
                           <span><i class='fa fa-image'></i><br>클릭하여 사진 추가</span>
                        </div>
                    </div>
                    <div class="col-md-8">
                        <div class="mb-3">
                            <label class="form-label">객실명</label>
                            <input type="text" class="form-control" name="roomTypes[${roomIndex}].typeName" placeholder="예: 디럭스 더블룸" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label">객실 설명</label>
                            <textarea class="form-control" name="roomTypes[${roomIndex}].description" rows="2" placeholder="예: 오션뷰, 킹사이즈 베드"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-sm-6 mb-3">
                                <label class="form-label">가격 (1박)</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="roomTypes[${roomIndex}].price" placeholder="숫자만 입력" required>
                                    <span class="input-group-text">원</span>
                                </div>
                            </div>
                            <div class="col-sm-6 mb-3">
                                <label class="form-label">최대 인원</label>
                                <div class="input-group">
                                    <input type="number" class="form-control" name="roomTypes[${roomIndex}].capacity" placeholder="숫자만 입력" required>
                                     <span class="input-group-text">명</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
        roomCardsContainer.insertAdjacentHTML('beforeend', cardHtml);
        roomIndex++; // Increment index for the next card
    }

    function deleteRoomCard(cardId) {
        const card = document.getElementById(cardId);
        if (card) {
            card.remove();
            // IMPORTANT: Re-indexing is needed if you delete items from the middle
            // For simplicity, this example doesn't re-index, which works fine if you only add/remove from the end.
            // A more robust solution would re-index all subsequent room cards.
        }
    }

    function previewRoomImage(event, previewId) {
        const previewContainer = document.getElementById(previewId);
        const file = event.target.files[0];
        if (file && file.type.startsWith('image/')) {
            const reader = new FileReader();
            reader.onload = function(e) {
                previewContainer.innerHTML = `<img src="${e.target.result}" alt="Room image preview"/>`;
            };
            reader.readAsDataURL(file);
        } else {
            previewContainer.innerHTML = "<span><i class='fa fa-image'></i><br>클릭하여 사진 추가</span>";
        }
    }
</script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
